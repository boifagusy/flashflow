# User Tracking and Notifications Example
# Demonstrates how to track user activities and send notifications

# Enhanced User model with notification preferences
model User {
  id: integer primary
  name: string required
  email: string required unique
  role: string enum:admin,user default:user
  created_at: timestamp auto
  last_login: timestamp
  notification_preferences: json
}

# Product model (from original example)
model Product {
  id: integer primary
  name: string required
  price: decimal required
  description: text
  category: string enum:electronics,clothing,books
  in_stock: boolean default:true
  created_at: timestamp auto
}

# User Activity model for tracking user interactions
model UserActivity {
  id: integer primary
  user_id: integer references User.id
  activity_type: string required
  page_url: string
  metadata: json
  timestamp: timestamp auto
  session_id: string
}

# Notification model for storing user notifications
model Notification {
  id: integer primary
  user_id: integer references User.id
  title: string required
  message: text required
  type: string enum:info,warning,success,error
  channel: string enum:in_app,email,push,sms
  status: string enum:pending,sent,delivered,read default:pending
  priority: string enum:low,normal,high,urgent default:normal
  created_at: timestamp auto
  sent_at: timestamp
  read_at: timestamp
}

# Web page with notification integration
page Dashboard {
  title: "User Dashboard with Notifications"
  route: "/dashboard"
  
  # Notification bell component in the header
  header {
    div class="header-container" {
      h1 "Dashboard"
      # Notification bell that shows unread count
      notification_bell {
        user_id: current_user.id
        position: right
      }
    }
  }
  
  section "User Activity Tracking" {
    h2 "Your Recent Activity"
    
    # Table showing user's recent activities
    table user_activities {
      columns: [activity_type, page_url, timestamp]
      data: recent_user_activities
      refresh: 30
    }
    
    # Chart showing activity trends
    chart activity_trends {
      type: line
      data: user_activity_trends
      refresh: 300
    }
  }
  
  section "Product Management" {
    h2 "Manage Products"
    
    # Product listing with activity tracking
    table products {
      columns: [name, price, category, in_stock]
      data: all_products
      on_row_click: {
        # Track when user views product details
        track_activity: {
          user_id: current_user.id
          activity_type: "product_view"
          page_url: "/products/" + product.id
          metadata: {product_id: product.id, product_name: product.name}
        }
        
        # Send notification to admins when popular products are viewed
        send_notification: {
          user_id: admin_users
          title: "Product Viewed"
          message: current_user.name + " viewed product: " + product.name
          type: "info"
          channel: "in_app"
          priority: "normal"
        }
      }
    }
    
    # Form to add new products with activity tracking
    form add_product {
      fields: [name, price, description, category, in_stock]
      model: Product
      on_submit: {
        # Track when user adds a product
        track_activity: {
          user_id: current_user.id
          activity_type: "product_create"
          page_url: "/products/create"
          metadata: {product_id: new_product.id}
        }
        
        # Send notification to team about new product
        send_notification: {
          user_id: all_users
          title: "New Product Added"
          message: "A new product '" + new_product.name + "' has been added by " + current_user.name
          type: "success"
          channel: "in_app"
          priority: "normal"
        }
      }
    }
  }
  
  section "Notification Settings" {
    h2 "Notification Preferences"
    
    # Component for managing notification settings
    notification_settings {
      user_id: current_user.id
    }
  }
}

# API endpoints for user tracking and notifications
endpoint TrackUserActivity {
  path: "/api/track-activity"
  method: POST
  description: "Track user activity"
  request: {
    user_id: integer required
    activity_type: string required
    page_url: string
    metadata: object
    session_id: string
  }
  response: {
    activity_id: integer
    success: boolean
  }
  auth: required
}

endpoint GetUserActivities {
  path: "/api/user-activities"
  method: GET
  description: "Get user activities"
  query_params: {
    user_id: integer required
    limit: integer default:50
  }
  response: {
    activities: array
  }
  auth: required
}

endpoint SendNotification {
  path: "/api/notifications/send"
  method: POST
  description: "Send a notification to a user"
  request: {
    user_id: integer required
    title: string required
    message: string required
    type: string
    channel: string
    priority: string
  }
  response: {
    notification_id: integer
    success: boolean
  }
  auth: required
}

endpoint GetUserNotifications {
  path: "/api/notifications"
  method: GET
  description: "Get notifications for a user"
  query_params: {
    user_id: integer required
    status: string
    limit: integer default:50
  }
  response: {
    notifications: array
  }
  auth: required
}

endpoint UpdateNotificationStatus {
  path: "/api/notifications/{id}/status"
  method: PUT
  description: "Update notification status (read, delivered, etc.)"
  path_params: {
    id: integer required
  }
  request: {
    status: string required
  }
  response: {
    success: boolean
  }
  auth: required
}

endpoint UpdateNotificationPreferences {
  path: "/api/notification-preferences"
  method: PUT
  description: "Update user notification preferences"
  request: {
    user_id: integer required
    preferences: object required
  }
  response: {
    success: boolean
  }
  auth: required
}

# Background job for sending scheduled notifications
job SendScheduledNotifications {
  schedule: "*/5 * * * *"  # Every 5 minutes
  description: "Send scheduled notifications"
  task: {
    # Get pending notifications
    pending_notifications = query: SELECT * FROM Notification WHERE status = 'pending' AND scheduled_at <= NOW()
    
    # Send each notification
    for notification in pending_notifications {
      send_notification: {
        to: notification.user_id
        title: notification.title
        message: notification.message
        channel: notification.channel
        priority: notification.priority
      }
      
      # Update notification status
      update Notification set status = 'sent', sent_at = NOW() where id = notification.id
    }
  }
}

# Analytics dashboard for admins to view user engagement
page AnalyticsDashboard {
  title: "User Analytics Dashboard"
  route: "/admin/analytics"
  auth: admin
  
  section "User Engagement Metrics" {
    h2 "User Engagement Overview"
    
    # Chart showing active users over time
    chart active_users {
      type: line
      data: daily_active_users
      refresh: 300
    }
    
    # Chart showing popular features
    chart popular_features {
      type: bar
      data: feature_usage
      refresh: 300
    }
    
    # Table showing user engagement scores
    table user_engagement {
      columns: [user_name, total_activities, last_activity, engagement_score]
      data: user_engagement_metrics
      sort: engagement_score desc
    }
  }
  
  section "Notification Performance" {
    h2 "Notification Metrics"
    
    # Chart showing notification delivery rates
    chart notification_delivery {
      type: area
      data: notification_delivery_rates
      refresh: 300
    }
    
    # Table showing notification statistics by type
    table notification_stats {
      columns: [type, sent, delivered, read, open_rate]
      data: notification_statistics
    }
  }
}