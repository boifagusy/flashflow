<!DOCTYPE html>
<html>
<head>
    <title>FlashCore WASM Demo</title>
</head>
<body>
    <h1>FlashCore WASM Demo</h1>
    <button id="runDemo">Run Vector Search Demo</button>
    <div id="output"></div>

    <script src="wasm_build/flashcore.js"></script>
    <script>
        document.getElementById('runDemo').addEventListener('click', async () => {
            try {
                // Load the WASM module
                const flashcore = await FlashCore();
                
                // Create HNSW index
                const index = flashcore._create_hnsw_index(4, 100);
                console.log('Created HNSW index:', index);
                
                // Add vectors to index
                const vec1 = new Float32Array([1.0, 2.0, 3.0, 4.0]);
                const vec1Ptr = flashcore._malloc(vec1.length * 4);
                flashcore.HEAPF32.set(vec1, vec1Ptr / 4);
                flashcore._add_vector_to_index(index, vec1Ptr, 1);
                
                const vec2 = new Float32Array([2.0, 3.0, 4.0, 5.0]);
                const vec2Ptr = flashcore._malloc(vec2.length * 4);
                flashcore.HEAPF32.set(vec2, vec2Ptr / 4);
                flashcore._add_vector_to_index(index, vec2Ptr, 2);
                
                // Search for nearest neighbors
                const query = new Float32Array([1.5, 2.5, 3.5, 4.5]);
                const queryPtr = flashcore._malloc(query.length * 4);
                flashcore.HEAPF32.set(query, queryPtr / 4);
                
                const resultIdsPtr = flashcore._malloc(3 * 4);
                const resultDistancesPtr = flashcore._malloc(3 * 4);
                
                const resultCount = flashcore._search_vector_in_index(index, queryPtr, 3, resultIdsPtr, resultDistancesPtr);
                console.log('Search result count:', resultCount);
                
                // Read results
                const resultIds = new Int32Array(flashcore.HEAP32.buffer, resultIdsPtr, resultCount);
                const resultDistances = new Float32Array(flashcore.HEAPF32.buffer, resultDistancesPtr, resultCount);
                
                // Display results
                let output = '<h2>Vector Search Results:</h2><ul>';
                for (let i = 0; i < resultCount; i++) {
                    output += `<li>ID: ${resultIds[i]}, Distance: ${resultDistances[i]}</li>`;
                }
                output += '</ul>';
                document.getElementById('output').innerHTML = output;
                
                // Clean up
                flashcore._free(vec1Ptr);
                flashcore._free(vec2Ptr);
                flashcore._free(queryPtr);
                flashcore._free(resultIdsPtr);
                flashcore._free(resultDistancesPtr);
                flashcore._destroy_hnsw_index(index);
                
            } catch (error) {
                console.error('Error running WASM demo:', error);
                document.getElementById('output').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>